\section*{概要}
画像からの異常検知は，完成品検査など幅広い応用があることから，これまでに多くの研究が行われてきた．本研究は，Bergmannらが定義した「論理的異常」―画像内に所定のオブジェクトが，決められた数および位置に存在するか否かが，正常・異常の判別基準となるような種類の異常―を対象に，新たなアプローチを提案する．提案手法は，正常品の条件が自然言語で記述可能であることを前提とし，大規模言語モデル（LLM）の高度なコーディング能力を活用する．具体的には，テキストとして与えられた正常性条件をプロンプトに取り込み，LLMに入力することで，1枚の画像から対象物が正常か異常かを判定するコンピュータビジョンプログラムを自動生成し，そのプログラムを実行することで目的を達成する．MVTec LOCO ADデータセットを用いた実験で，提案手法が従来の異常検知手法と同等以上の精度を実現することを示し，従来扱いにくかった論理的異常の検出を可能にする新たな枠組みとして有望であることを示す．



\section{はじめに}

画像を用いた異常検知，すなわち物体の画像からそこにある何らかの異常を検知する問題は，特に産業界を中心に関心が寄せられてきた．
% 工場で製品を生産する際，大量の完成品の中に混じる異常を，人手を介さず自動で検知したい，という要請である．
% 一言で異常検知といっても，
異常の発生原因や条件は多岐にわたるため，様々な問題設定が考えられてきたが，最も盛んなのが「無教師異常検知」の研究である．これは，不良品が稀にしか発生せず十分な事例を集められない，あるいは不良品のバリエーションが多すぎて事前に把握できないなどの理由から，大量に入手可能な正常品の画像のみをAIに学習させ，そこから逸脱するものを異常として検出するという考え方である．

この問題設定に対し，関連分野では多くのデータセットや手法が提案され，多大な努力が注がれてきた\cite{bergmann2019mvtec, bergmann2022beyond, liu2023simplenet, patchcore}．しかし，未解決の課題も数多く残っている．その一つに，「論理的異常（logical anomaly）」の検出がある．

論理的異常とは，Bergmannら\cite{bergmann2022beyond}によって導入された概念であり，異常を「構造的異常」と「論理的異常」の2つに分類する考え方に基づいている（図\ref{figure:anomaly_types}に両者の例を示す）．構造的異常は，例えば製造過程で生じる表面の欠け，汚れ，テクスチャの乱れなど，見た目から判断できるタイプの異常である．一方，論理的異常とは，「あるべき部品がない」，「数量や配置が正しくない」，または「本来あってはいけない部品が存在する」など，見た目だけでは判断が難しい異常を指す（なお，これら2種類の異常の境界は必ずしも明確ではない）．従来は構造的異常の検出手法が多数提案されてきたが\cite{zavrtanik2021draem,rudolph2023AST,patchcore,liu2023simplenet,chen2024unified}，論理的異常の検出手法は比較的少なかった\cite{bergmann2022beyond,cohen2024set, liu2023component,hsieh2024csad}．また前者のための手法は大抵において論理的異常には有効ではなかった．
\begin{figure}[tb]
\centering
  \includegraphics[width=.99\linewidth]{image/all_types_pushpins.pdf}
\caption{(a)正常画像．(b)構造的異常．
(c,d)論理的異常．}
\label{figure:anomaly_types}
\end{figure}


本稿では，この論理的異常に焦点を当て，大規模言語モデル（LLM）のコーディング能力を活用する新しい異常検知手法を提案する．具体的には，まずユーザーが正常品の満たすべき条件を自然言語で記述し，それをLLMに入力する．すると，LLMがその記述をもとに，入力画像が正常条件を満たすかどうかを判定するコンピュータビジョンのプログラムを自動生成するという方法である．

提案手法の背景には，論理的異常の場合，「正常」の定義を言葉で表現することは困難ではなく，むしろ自然であるという事実がある．既存のベンチマーク（例えばMVTec AD-LOCO\cite{bergmann2022beyond}）は，前述の無教師異常検知の枠組みに厳密に従ってデザインされており，大量の正常画像のみを用いて異常検知を行うことを前提としている．この設定はある程度有効だが，現場でのニーズには必ずしも合致しない．実際のユーザーにとっては，大量の正常品画像を収集・提示するよりも，正常品の条件を言葉で明示する方が，簡単かつ実用的な場合が多い．図に示した例では，「3×5のセルがあり，各セルにピンが1つずつ収まっている」という正常条件を言語化することは難しくなく，ユーザーの負担も軽い．

また，正常品に許容されるばらつきが大きい場合
% （例えば図\ref{figure:breakfastbox_normal}の`Breakfast Box'）
には，そのばらつきをすべて網羅する正常例を用意することが困難なこともあり，その場合は利便性や性能の低下につながり得る．このようなケースでは，むしろ正常品の条件を簡潔に言葉で指定する方が望ましいと言える．なお，構造的異常はその性質上，言語化には向かないことに注意されたい．

% \begin{figure}[tb]
% \centering
%   \includegraphics[width=.99\linewidth]{image/normal_breakfastbox.pdf}
% \caption{正常品のばらつきの様子．}
% \label{figure:breakfastbox_normal}
% \end{figure}

提案手法は，2つの要素に支えられている．1つ目は，近年のLLMが極めて高度なコーディング能力を備えている点である．LLMを用いて個別のコンピュータビジョンの課題を解決するために，プログラムを自動生成させる手法は既に存在する\cite{gupta2023visual, suris2023vipergpt}．
% 最新のreasoningモデルは競技プログラミングにおいて，トップレベルの人間エンジニアに匹敵する能力を持つと報告されている[]．

もう1つは，近年のコンピュータビジョンにおいて，個別タスクの性能が著しく向上している点である．具体的には，オープンボキャブラリや視覚プロンプトを活用した物体検出\cite{minderer2023scaling,liu2023grounding,ren2024dinoxunifiedvisionmodel, jiang2024t}，SAMに代表される学習不要の高性能セグメンテーション\cite{kirillov2023segment}，あるいは数を数えるなどの特定タスクに特化した精度の高い手法\cite{ren2024dinoxunifiedvisionmodel}の登場が挙げられる．これらの個別タスクを解く手法群を，コンポーネントとして適切に組み合わせれば，高精度な異常検知プログラムを作成することが可能となっている．

論理的異常を含むMVTec LOCO AD\cite{bergmann2022beyond}上で評価したところ，実験提案手法は，従来の異常検知手法と同等以上の異常検知精度を達成可能なことを示した．提案するアプローチは，未だ完全解決には至っていない異常検知の課題，特に論理的異常の取り扱いに新たな視点を提供する．